{"title":"活动引擎的查询语法","zzzContent":"活动引擎查询串说明:\n\n## 引擎的查询语法:\n\n##引擎串示例 ##\nconfig=cluster:mainseact2,no_summary:no,start:0,hit:4,fetch_summary_type:rawpk,qrs_chain:MAINSEACT2,rerank_size:5000,result_compress:z_speed_compress,format:protobuf,proto_format_option:summary_in_bytes,sub_doc:flat&&attribute=sub_material_id,sub_picture_url,sub_picture_size,sub_picture_url_ext,sub_picture_size_ext,sub_text,sub_category_ids,sub_material_type,sub_material_content,sub_rid,sub_time_start,sub_time_end&&query=sub_rid:0&&filter=act_start_time<2 AND act_end_time=0 AND status=1&&sort=-RANK&&rank=rank_profile:ScorerAudition&&virtual_attribute=ENDTIME:nid;PS:ENDTIME&&final_sort=sort_name:AdapterSorter&&kvpairs=et:6390&&distinct=dist_key:activity_id,dist_count:1,dist_times:1,reserved:false\n\n通过url体验一下:[click me !](http://10.103.3.111:8080/config=cluster:mainseact2,no_summary:no,start:0,hit:4,fetch_summary_type:rawpk,qrs_chain:MAINSEACT2,rerank_size:5000,sub_doc:flat&&attribute=sub_material_id,sub_picture_url,sub_picture_size,sub_picture_url_ext,sub_picture_size_ext,sub_text,sub_category_ids,sub_material_type,sub_material_content,sub_rid,sub_time_start,sub_time_end&&query=sub_rid:0&&filter=act_start_time<2%20AND%20act_end_time=0%20AND%20status=1&&sort=-RANK&&rank=rank_profile:ScorerAudition&&virtual_attribute=ENDTIME:nid;PS:ENDTIME&&final_sort=sort_name:AdapterSorter&&kvpairs=et:6390&&distinct=dist_key:activity_id,dist_count:1,dist_times:1,reserved:false)\n\n##ha3引擎参数说明\n\n 参数 | 说明 \n-----|------\n config\t| cluster:mainseact2,no_summary:no,start:0,hit:4,fetch_summary_type:rawpk,qrs_chain:MAINSEACT2,rerank_size:5000,result_compress:z_speed_compress,format:protobuf,proto_format_option:summary_in_bytes,sub_doc:flat \n attribute\t|sub_material_id,sub_picture_url,sub_picture_size,sub_picture_url_ext,sub_picture_size_ext,sub_text,sub_category_ids,sub_material_type,sub_material_content,sub_rid,sub_time_start,sub_time_end \n query\t| sub_rid:0 \n filter\t| act_start_time<2 AND act_end_time=0 AND status=1 \n sort\t| -RANK \n rank\t| rank_profile:ScorerAudition \n virtual_attribute\t| ENDTIME:nid;PS:ENDTIME\t \nfinal_sort\t| sort_name:AdapterSorter \n kvpairs\t| et:6390 \n distinct\t| dist_key:activity_id,dist_count:1,dist_times:1,reserved:false \n\n### 实际中常变的参数 ###\n#### et\n 1. ** et后面数字 需要传一个当前时间相关的数字,数字不同,排序结果不同; **\n 1. ** 此数字实现了随机排序的功能 **\n\n#### query\nquery 的改动量要大一点,对于按资源位来调用,一般是传sub_rid进去,对于搜索的来说,则除开要传资源位之外,还需要传qid进去;\n\n比如,假设首页某资源位ID是tce_101,则query段的拼法就是\n\n       query=sub_rid:tce_101\n如果LSRP页面,搜索连衣裙,在前台类目16下,则要传qid;\n先计算qid:\n\n    qid=HashFunc(\"连衣裙\"+\"\\01\"+\"16\"+\"\\01\")\n得到qid是3612382211,则 query 是:\n\n      query=sub_rid:tce_160 AND qid:3612382211\n      query=sub_rid:tce_160 AND (category_ids:16 OR category_ids:52)\n \n#### filter \n 使用filter 是为了把过期的活动,下线的活动等都排除掉; \n \n 采用的条件一般是,活动开始时间小于当前时间 ,活动结束时间大于当前时间,素材开始时间小于当前时间 ,素材结束时间大于当前时间 ,且活动是上线状态;\n 因此翻译过来的filter就是:(假定当前时间是1443598070002)\n \n     filter=act_start_time<14435980700022 AND act_end_time>1443598070002 AND sub_time_start<1443598070002 AND sub_time_end>1443598070002 AND status=1 \n new Date().getTime()\n \n## Sp请求串说明:##\n\n1. ** sp的构造方式基本不太需要变化; **\n1. ** sp_debug 在调试时不需要打开; **\n1. ** outfmt在线上请置为json,在调试时置为json2 **\n \n  参数 |  说明 \n  ----|------\n target_service |\tqrs4oe_tejia,正式上线前这个值会被换掉;\nurl |\t前一章节介绍的ha3引擎的请求串,要做urlencode之后传进来,特别注意空格要转义成%20,不能转义成加号('+')\nsp_debug\t| query\noutfmt |\tjson2\napp |\tpasson\n\n\n## qid 计算方法\nqid的计算,采用这个算法:\n\n    HashFuncStr(query+\"\\01\"+categoryId+\"\\01\")\n\n完整的java代码 :\n\n<pre>\npackage com.taobao.search.algo.test;\n\nimport java.io.UnsupportedEncodingException;\nimport java.util.Date;\n\npublic class TestHash {\n    static long[] prims = {\n            0x01EE5DB9, 0x491408C3, 0x0465FB69, 0x421F0141,\n            0x2E7D036B, 0x2D41C7B9, 0x58C0EF0D, 0x7B15A53B,\n            0x7C9D3761, 0x5ABB9B0B, 0x24109367, 0x5A5B741F,\n            0x6B9F12E9, 0x71BA7809, 0x081F69CD, 0x4D9B740B,\n    };\n\n    public static long HashFuncStr(String old) throws UnsupportedEncodingException {\n        long sum = 0;\n        byte[] bs = old.getBytes(\"GBK\");\n        int i = 0;\n        for (; i < bs.length; i++) {\n            if (bs[i] > 0) {\n                sum = (sum + prims[i & 15] * (bs[i])) & 4294967295l;\n            } else {\n                sum = (sum + prims[i & 15] * (256 + bs[i])) & 4294967295l;\n            }\n        }\n        return sum;\n    }\n\n    public static long HashQueryAndCategory(String query,String categoryId) throws UnsupportedEncodingException {\n        return HashFuncStr(query+\"\\01\"+categoryId+\"\\01\");\n    }\n    \n    public static void main(String[] args) {\n        try {\n            System.out.println(new Date().getTime());\n            System.out.println(HashFuncStr(\"我的天\"));\n            System.out.println(HashQueryAndCategory(\"0-1岁男宝宝秋装\",\"50006004\"));\n\n            System.out.println(HashFuncStr(\"连衣裙\"));\n            System.out.println(HashQueryAndCategory(\"连衣裙\",\"16\"));\n        } catch (Exception e) {\n            e.printStackTrace();\n        }\n        //System.out.println(0x01EE5DB9);\n    }\n\n\n}\n\n</pre>\n\n\n## 输出说明:\n\n这是一段示意输出:\n\n```javascript\n{\n    \"passon\": {\n        \"head\": {\n            \"Version\": \"V1.0\",\n            \"Status\": \"OK\",\n            \"SearchTime\": 2820,\n            \"DocsReturn\": 4,\n            \"DocsFound\": 109,\n            \"DocsRestrict\": 109,\n            \"DocsSearch\": 109\n        },\n        \"auctions\": [\n            {\n                \"sortExprValues\": \"0;0\",\n                \"activity_id\": \"1030\", //活动ID,scm埋点用\n                \"name\": \"极\\t有\\t家的\\t装饰\\t画\",\n                \"description\": \"极\\t有\\t家的\\t装饰\\t画\",\n                \"act_start_time\": \"0\",\n                \"act_end_time\": \"0\",\n                \"category_level_one\": \"0\",\n                \"category_ids\": \"\",\n                \"industry_id\": \"0\",\n                \"status\": \"1\",//活动状态,是1表示正常投放的;\n                \"type\": \"1\",\n                \"pc_url\": \"http://www.taobao.com/market/2015dacu/active/more.php?aid=100000517\",\n                //PC端的活动页面\n                \"wireless_url\": \"\",\n                \"data_source\": \"3\",//表征上游来源\n                \"act_info\": \"\",\n                \"categoryp\": \"\",\n                \"text_info\": \"\",\n                \"sub_category_ids\": \"\",\n                \"sub_material_content\": \"\",\n                \"sub_material_id\": \"1029\",\n                \"sub_material_type\": \"0\",\n                \"sub_picture_size\": \"250x500\", //素材大小\n                \"sub_picture_size_ext\": \"\",\n                \"sub_picture_url\": \"http://gtms01.alicdn.com/tps/i1/TB1ecZZIVXXXXcwXFXXAARJFFXX-880-70.jpeg\",//素材地址\n                \"sub_picture_url_ext\": \"\",\n                \"sub_rid\": \"0\",//资源位ID\n                \"sub_text\": \"\",\n                \"sub_time_end\": \"0\",//素材结束时间\n                \"sub_time_start\": \"0\" //素材开始时间\n            }\n        ]\n    }\n}    \n```\n\n\n","postDate":"2018-01-01 02:03:36","postId":71,"type":"post","status":"publish","imported":false,"file":"活动引擎的查询语法.md"}